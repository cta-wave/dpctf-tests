<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title></title>
    <script src="/resources/testharness.js"></script>
    <script src="/resources/testharnessreport.js"></script>
    <script src="../subtests/start-up-delay-should-be-sufficiently-low.js"></script>
    <script src="../subtests/playback-duration-matches-cmaf-track-duration.js"></script>
  </head>

  <body>
    <video style="height: 400px;"></video>
    <div>Press Enter/Ok to continue or Up/Down to show/hide debug overlay</div>
    <div id="debug"></div>
    <div id="log"></div>
    <div id="info-overlay"></div>
    <script src="../lib/mozilla/object-keys-polyfill.js"></script>
    <script src="../lib/stefanpenner/es6-promise.min.js"></script>
    <script src="../lib/player.js"></script>
    <script src="../lib/manifest_parser.js"></script>
    <script src="../lib/mpd-parser.js"></script>
    <script src="../lib/wave-service.js"></script>
    <script src="../lib/dpctf-testharness.js"></script>
    <script>
      // Global variables
      var TEST_INFO = {
        title: "Switching Set Playback",
        description:
          "Playback of a switching set assumes that the application can switch across the fragments of different tracks without observing any temporal or spatial misalignment during playback.",
        path: location.pathname,
        params: urlParams,
        observations: [],
      };
      var video = document.querySelector("video");

      var tsMax = urlParams["tsMax"] || 120;
      var minBufferDuration = urlParams["min_buffer_duration"] || 30;
      var videoContentModel = "http://dash.akamaized.net/WAVE/ContentModel/SinglePeriod/Fragmented/ToS_MultiRate_fragmented.mpd";
      var audioContentModel = "https://dash.akamaized.net/WAVE/ContentModel/SinglePeriod/Fragmented/ToS_HEAACv2_fragmented.mpd";
      var playout = urlParams["playout"] || 0;
      var token = urlParams["token"];

      new DpctfTest({
        testInfo: TEST_INFO,
        minBufferDuration: minBufferDuration,
        token: token,
        videoContentModel: videoContentModel,
        videoElement: video,
        infoOverlayElement: document.getElementById("info-overlay"),
        executeTest: executeTest,
        setupTest: setupTest,
      });

      function setupTest(player, done) {
        var manifest = player.getVideoManifest();
        var totalSegmentsCount = manifest
          .getRepresentation(playout)
          .getTotalSegmentsCount();
        player.setVideoSegments({
          representationNumber: playout,
          startSegment: 0,
          endSegment: totalSegmentsCount / 2 - 1,
        });
        playout++;
        if (playout >= totalSegmentsCount) {
          playout = 0;
        }
        player.setVideoSegments({
          representationNumber: playout,
          startSegment: totalSegmentsCount / 2,
          endSegment: totalSegmentsCount - 1,
        });
        done();

        //document.addEventListener("keydown", function (event) {
        //  if (event.keyCode === 13) {
        //    var repIndex =
        //      player
        //        .getManifest()
        //        .getRepresentations()
        //        .indexOf(player.playingRepresentation) + 1;
        //    if (repIndex >= player.getVideoManifest().representations.length) {
        //      repIndex = 0;
        //    }
        //    var totalSegmentsCount = player
        //      .getManifest()
        //      .getRepresentation(1)
        //      .getTotalSegmentsCount();
        //    player.setVideoSegments({
        //      representationNumber: repIndex,
        //      startSegment: player.getPlayingSegment().number,
        //      endSegment: totalSegmentsCount - 1,
        //    });
        //  }
        //});
      }

      function executeTest(player, done) {
        player.startBuffering();
        if (player.getPreBufferedTime() >= minBufferDuration) {
          player.play();
        } else {
          player.on("onVideoSegmentLoaded", function (event) {
            if (player.getPreBufferedTime() >= minBufferDuration) {
              player.play();
            }
          });
        }

        async_test(function (test) {
          video.addEventListener(
            "play",
            test.step_func(function (event) {
              if (video.paused) return;
              assert_true(true);
              test.done();
            })
          );
        }, "Playback starts");

        async_test(function (test) {
          var count = 0;
          video.addEventListener(
            "timeupdate",
            test.step_func(function (event) {
              count += 1;
              if (count < 5) return;
              assert_true(true);
              test.done();
            })
          );
        }, "5 time update events fired");

        done();
      }
    </script>
  </body>
</html>
